<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í•œêµ­ê´€ê´‘ API í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; }
    #container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .card img { width: 100%; height: 200px; object-fit: cover; background-color: #ddd; }
    .card-content { padding: 15px; }
    .card-title { font-size: 1.1em; font-weight: 800; margin-bottom: 8px; color: #333; }

    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .addr-strong { font-size: 0.95em; color: #444; margin-bottom: 4px; }
    .addr-full { font-size: 0.88em; color: #777; margin-bottom: 8px; }

    .pills { display: flex; gap: 6px; flex-wrap: wrap; margin: 10px 0 8px; }
    .pill { font-size: 0.82em; background: #f1f5f9; color: #0f172a; padding: 4px 8px; border-radius: 999px; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .link { font-size: 0.85em; color: #0d6efd; text-decoration: none; }
    .link:hover { text-decoration: underline; }

    .btn {
      font-size: 0.82em; border: 1px solid #ddd; background: #fff; color: #111;
      padding: 5px 8px; border-radius: 8px; cursor: pointer;
    }
    .btn:hover { border-color: #aaa; }

    .card-tags { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
    .tag { font-size: 0.82em; background: #eef2ff; color: #2f3a8f; padding: 4px 8px; border-radius: 999px; }
  </style>
</head>
<body>

  <h1>ğŸ‡°ğŸ‡· êµ­ë‚´ ê´€ê´‘ì§€ ë¦¬ìŠ¤íŠ¸ (areaBasedList2)</h1>
  <p style="color:#555;margin-top:-6px;">
    (ì¶”ê°€ í˜¸ì¶œ 0) ì´ë¯¸ì§€/ê±°ë¦¬/ì£¼ì†Œê°•ì¡°/í•´ì‹œíƒœê·¸ + <b>ì¹´ì¹´ì˜¤ë§µ ë§í¬</b> + <b>ì¢Œí‘œ ë³µì‚¬</b>
  </p>

  <div id="container">
    <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
  </div>

  <template id="cardTpl">
    <div class="card">
      <img class="img" src="" alt="ê´€ê´‘ì§€ ì´ë¯¸ì§€">
      <div class="card-content">
        <div class="card-title"></div>

        <div class="addr-strong"></div>
        <div class="addr-full"></div>

        <div class="pills">
          <span class="pill dist"></span>
          <span class="pill coord"></span>
        </div>

        <div class="actions">
          <a class="link mapLink" target="_blank" rel="noreferrer">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a>
          <button class="btn copyBtn" type="button">ì¢Œí‘œ ë³µì‚¬</button>
        </div>

        <div class="card-tags"></div>
      </div>
    </div>
  </template>

  <script>
    async function fetchTourData() {
      const container = document.getElementById("container");
      const tpl = document.getElementById("cardTpl");

      const API_KEY = "2fcc44b4d99263a5f44b3e7867fa1eddaec3261ce6f04843d005ee3c7c2d10b7";

      const url =
        "https://apis.data.go.kr/B551011/KorService2/areaBasedList2"
        + "?serviceKey=" + encodeURIComponent(API_KEY)
        + "&numOfRows=10&pageNo=1&MobileOS=ETC&MobileApp=AppTest&_type=json"
        + "&areaCode=1"
        + "&contentTypeId=12";

      // âœ… ì¤‘ì‹¬: ë‚´ ìœ„ì¹˜ ìš°ì„ , ì‹¤íŒ¨í•˜ë©´ ì„œìš¸ ì‹œì²­
      const fallbackCenter = { lat: 37.5665, lng: 126.9780 };
      const userCenter = await getUserLocation().catch(() => null);
      const center = userCenter ?? fallbackCenter;

      try {
        const response = await fetch(url);
        const raw = await response.text();

        if (!response.ok) {
          container.innerHTML = `
            <p style="color:red;">
              HTTP ${response.status} ë¡œ ì‹¤íŒ¨.<br>
              ì‘ë‹µ ì•ë¶€ë¶„: <pre>${escapeHtml(raw.slice(0, 300))}</pre>
            </p>`;
          return;
        }

        let data;
        try {
          data = JSON.parse(raw);
        } catch {
          container.innerHTML = `
            <p style="color:red;">
              JSON íŒŒì‹± ì‹¤íŒ¨(ì‘ë‹µì´ JSONì´ ì•„ë‹˜).<br>
              ì‘ë‹µ ì•ë¶€ë¶„: <pre>${escapeHtml(raw.slice(0, 300))}</pre>
            </p>`;
          return;
        }

        const items = data.response?.body?.items?.item;
        if (!items) {
          const msg = data.response?.header?.resultMsg || "ë°ì´í„° ì—†ìŒ";
          container.innerHTML = `<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ë©”ì‹œì§€: ${escapeHtml(msg)})</p>`;
          return;
        }

        container.innerHTML = "";
        const list = Array.isArray(items) ? items : [items];

        list.forEach((item, idx) => {
          const clone = tpl.content.cloneNode(true);

          // ì´ë¯¸ì§€
          clone.querySelector(".img").src =
            item.firstimage || item.firstimage2 || `https://picsum.photos/600/400?random=${idx}`;

          // ì œëª©
          clone.querySelector(".card-title").innerText = item.title || "(ì œëª© ì—†ìŒ)";

          // ì£¼ì†Œ ê°•ì¡°(êµ¬/ë™) + ì „ì²´ ì£¼ì†Œ
          const { short, full } = formatAddress(item.addr1, item.addr2);
          clone.querySelector(".addr-strong").innerText = short ? `ğŸ“ ${short}` : "ğŸ“ ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
          clone.querySelector(".addr-full").innerText = full ? full : "";

          // ì¢Œí‘œ
          const lat = Number(item.mapy);
          const lng = Number(item.mapx);

          // ê±°ë¦¬ ë±ƒì§€
          const distEl = clone.querySelector(".dist");
          if (Number.isFinite(lat) && Number.isFinite(lng)) {
            const km = haversineKm(center.lat, center.lng, lat, lng);
            distEl.textContent = userCenter ? `ë‚´ ìœ„ì¹˜ì—ì„œ ${km.toFixed(1)}km` : `ì¤‘ì‹¬ì—ì„œ ${km.toFixed(1)}km`;
          } else {
            distEl.textContent = "ê±°ë¦¬ ì •ë³´ ì—†ìŒ";
          }

          // âœ… ì¶”ê°€ 1) ì¹´ì¹´ì˜¤ë§µ ë§í¬(ì¢Œí‘œ ê¸°ë°˜)
          const mapLinkEl = clone.querySelector(".mapLink");
          if (Number.isFinite(lat) && Number.isFinite(lng)) {
            mapLinkEl.href = `https://map.kakao.com/link/map/${encodeURIComponent(item.title || "ê´€ê´‘ì§€")},${lat},${lng}`;
          } else {
            mapLinkEl.href = "#";
            mapLinkEl.textContent = "ì§€ë„ ë§í¬ ì—†ìŒ";
            mapLinkEl.style.pointerEvents = "none";
            mapLinkEl.style.opacity = "0.5";
          }

          // âœ… ì¶”ê°€ 2) ì¢Œí‘œ í‘œì‹œ + ë³µì‚¬ ë²„íŠ¼
          const coordEl = clone.querySelector(".coord");
          const copyBtn = clone.querySelector(".copyBtn");

          if (Number.isFinite(lat) && Number.isFinite(lng)) {
            coordEl.textContent = `ì¢Œí‘œ ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
            copyBtn.addEventListener("click", async () => {
              const text = `${lat},${lng}`;
              try {
                await navigator.clipboard.writeText(text);
                copyBtn.textContent = "ë³µì‚¬ë¨!";
                setTimeout(() => (copyBtn.textContent = "ì¢Œí‘œ ë³µì‚¬"), 900);
              } catch {
                // í´ë¦½ë³´ë“œ ê¶Œí•œ ì‹¤íŒ¨ fallback
                alert(`ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•˜ì„¸ìš”: ${text}`);
              }
            });
          } else {
            coordEl.textContent = "ì¢Œí‘œ ì—†ìŒ";
            copyBtn.disabled = true;
            copyBtn.style.opacity = "0.5";
            copyBtn.style.cursor = "not-allowed";
          }

          // í•´ì‹œíƒœê·¸(ê³ ë„í™”: ì§€ì—­+ê´€ê´‘ì§€+ì‚¬ì§„)
          const tags = generateHashtags(item);
          const tagsEl = clone.querySelector(".card-tags");
          tagsEl.innerHTML = tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("");

          container.appendChild(clone);
        });

      } catch (error) {
        console.error("ì—ëŸ¬ ë°œìƒ:", error);
        container.innerHTML = `<p style="color:red;">ì˜¤ë¥˜ ë°œìƒ: ${escapeHtml(error.message)}</p>`;
      }
    }

    // ---------- ìœ í‹¸ ----------

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function getUserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error("Geolocation not supported"));
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          (err) => reject(err),
          { enableHighAccuracy: false, timeout: 6000, maximumAge: 60000 }
        );
      });
    }

    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function deg2rad(d) {
      return d * (Math.PI / 180);
    }

    // addr1/addr2ì—ì„œ êµ¬/ë™ ê°•ì¡°
    function formatAddress(addr1 = "", addr2 = "") {
      const full = [addr1, addr2].filter(Boolean).join(" ");
      const parts = addr1.trim().split(/\s+/).filter(Boolean);

      // ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ ..." -> "ì¤‘êµ¬ â€¢ ì„¸ì¢…ëŒ€ë¡œ" ì •ë„
      let gu = "";
      let dong = "";

      // partsì—ì„œ ëì´ "êµ¬/êµ°/ì‹œ" ê°™ì€ í† í° ì°¾ê¸°
      for (const p of parts) {
        if (!gu && /êµ¬$|êµ°$|ì‹œ$/u.test(p)) gu = p;
        if (!dong && /ë™$|ì$|ë©´$/u.test(p)) dong = p;
      }

      const short = [gu, dong].filter(Boolean).join(" â€¢ ");
      return { short, full };
    }

    function extractRegionHashtags(addr1 = "") {
      const parts = addr1.trim().split(/\s+/).filter(Boolean);
      const tags = [];
      if (parts[0]) tags.push("#" + normalizeTag(parts[0]));
      if (parts[1]) tags.push("#" + normalizeTag(parts[1]));
      return tags;
    }

    function normalizeTag(s) {
      return String(s)
        .replace(/[^\p{L}\p{N}]+/gu, "")
        .replace(/íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|ìì¹˜ì‹œ|ìì¹˜ë„|ë„|ì‹œ|êµ°|êµ¬$/u, "");
    }

    function generateHashtags(item) {
      const tags = new Set();

      if (item.title) tags.add("#" + normalizeTag(item.title));
      extractRegionHashtags(item.addr1).forEach(t => tags.add(t));
      tags.add("#ê´€ê´‘ì§€");

      if (item.firstimage || item.firstimage2) tags.add("#ì‚¬ì§„");
      if ((item.title || "").includes("ê³µì›") || (item.addr1 || "").includes("ê³µì›")) tags.add("#ì‚°ì±…");

      const cleaned = [...tags].filter(t => t.length > 1 && t.length <= 15);
      return cleaned.slice(0, 6);
    }

    fetchTourData();
  </script>
</body>
</html>
